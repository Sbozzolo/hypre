#!/bin/sh
# Copyright (c) 1998 Lawrence Livermore National Security, LLC and other
# HYPRE Project Developers. See the top-level COPYRIGHT file for details.
#
# SPDX-License-Identifier: (Apache-2.0 OR MIT)

EXTH="HYPRE_krylov.h"
INTH="_hypre_krylov.h"
OUTP="mup"

#### NOTE: Add mup.methods to this later.
####
#### It should be easy to just add it to the loops below, but some up-front
#### preprocessing will be necessary to move existing implementation code out of
#### the way temporarily to prevent overwriting existing code.  Developers will
#### then need to do a manual merge.  The header files can be generated fully
#### automatically as below.

############################################################################
# Create temporary files
############################################################################

# Create file with list of MUP functions and methods
cat mup.functions mup.methods > mup.pre

# Create prototype information files
for i in fixed functions
do
    ../config/gen_proto_info.sh mup.${i} ${EXTH} > ${OUTP}.${i}.ext.proto
    ../config/gen_proto_info.sh mup.${i} ${INTH} > ${OUTP}.${i}.int.proto
done
cat ${OUTP}.functions.ext.proto > ${OUTP}.pre.ext.proto
cat ${OUTP}.functions.int.proto > ${OUTP}.pre.int.proto

# Create C implementation files and header files
for i in fixed functions pre
do
    ../config/gen_${i}_code.sh ${OUTP}.${i}.ext.proto ${OUTP}_${i}_ext
    ../config/gen_${i}_code.sh ${OUTP}.${i}.int.proto ${OUTP}_${i}_int
done

############################################################################
# Generate code
############################################################################

for i in fixed functions pre
do

#========================================
# generate implementation file
#========================================

FOUT=${OUTP}_${i}.c

cat > $FOUT <<@

/*** DO NOT EDIT THIS FILE DIRECTLY (use $0 to generate) ***/

#include "$INTH"

#ifdef HYPRE_MIXED_PRECISION

@

../config/write_header.sh >> $FOUT
cat ${OUTP}_${i}_ext.c ${OUTP}_${i}_int.c >> $FOUT

cat >> $FOUT <<@

#endif

@

#========================================
# add header info to the prototype files
#========================================

FOUT=${OUTP}_${i}_ext.h
cat > $FOUT.tmp <<@

/*** DO NOT EDIT THIS FILE DIRECTLY (use $0 to generate) ***/

@
../config/write_header.sh >> $FOUT.tmp
cat $FOUT >> $FOUT.tmp
mv $FOUT.tmp $FOUT

FOUT=${OUTP}_${i}_int.h
cat > $FOUT.tmp <<@

/*** DO NOT EDIT THIS FILE DIRECTLY (use $0 to generate) ***/

@
../config/write_header.sh >> $FOUT.tmp
cat $FOUT >> $FOUT.tmp
mv $FOUT.tmp $FOUT

done

############################################################################
# Remove temporary files
############################################################################

rm -f mup.pre
rm -f ${OUTP}.*.proto
rm -f ${OUTP}_*_ext.c
rm -f ${OUTP}_*_int.c

